{% comment %} 
  Cart Uplift - Theme App Extension.
  This app embed enables a custom cart drawer with upsells and free shipping progress
{% endcomment %}

{% if block.settings.enable_app %}
  {% comment %} Load CSS first {% endcomment %}
  <link rel="stylesheet" href="{{ 'cart-uplift.css' | asset_url }}">
  
  {% comment %} Initialize UpCart with settings and data BEFORE loading the main script {% endcomment %}
  <script>
    (function() {
      // Preload cart data for faster initial load
      window.CartUpliftPreloadedCart = {{ cart | json }};
      
      // Store money format for proper price display
      window.CartUpliftMoneyFormat = {{ shop.money_format | json }};
      
      // Store shop information
      window.CartUpliftShopInfo = {
        domain: {{ shop.permanent_domain | json }},
        currency: {{ shop.currency | json }},
        moneyFormat: {{ shop.money_format | json }},
        moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }}
      };
      
      // Main Cart Uplift settings from theme editor
      window.CartUpliftSettings = {
        // General settings
        enableApp: true,
        shopDomain: {{ shop.permanent_domain | json }},
        
        // Sticky cart settings
        enableStickyCart: {{ block.settings.enable_sticky_cart | default: true | json }},
        showOnlyOnCartPage: {{ block.settings.show_only_on_cart_page | default: false | json }},
        cartPosition: {{ block.settings.cart_position | default: 'bottom-right' | json }},
        cartIcon: {{ block.settings.cart_icon | default: 'cart' | json }},
        
        // Free shipping settings
        enableFreeShipping: {{ block.settings.enable_free_shipping | default: true | json }},
        freeShippingThreshold: {{ block.settings.free_shipping_threshold | default: 100 | json }},
        shippingMessage: {% assign default_msg = 'You are {amount} away from free shipping!' %}{{ block.settings.shipping_message | default: default_msg | json }},
        shippingSuccessMessage: {{ block.settings.shipping_success_message | default: 'üéâ Congratulations! You have unlocked free shipping!' | json }},
        
        // Styling settings
        backgroundColor: {{ block.settings.background_color | default: '#1a1a1a' | json }},
        textColor: {{ block.settings.text_color | default: '#FFFFFF' | json }},
        buttonColor: {{ block.settings.button_color | default: '#4CAF50' | json }},
        
        // Upsell and recommendation settings
        enableUpsells: {{ block.settings.enable_upsells | default: true | json }},
        enableRecommendations: {{ block.settings.enable_recommendations | default: true | json }},
        recommendationLayout: {{ block.settings.recommendation_layout | default: 'row' | json }},
        enableQuantityBreaks: {{ block.settings.enable_quantity_breaks | default: false | json }},
        maxUpsells: {{ block.settings.max_upsells | default: 4 | json }},
        
        // Add-on settings
        enableAddons: {{ block.settings.enable_addons | default: false | json }},
        enableExpressCheckout: {{ block.settings.enable_express_checkout | default: true | json }},
        
        // Additional settings
        enableNotes: {{ block.settings.enable_notes | default: false | json }},
        enableDiscountCode: {{ block.settings.enable_discount_code | default: false | json }},
        autoOpenCart: {{ block.settings.auto_open_cart | default: true | json }},
        
        // Localization
        locale: {{ request.locale.iso_code | json }},
        
        // Page context
        currentPage: {
          template: {{ template | json }},
          pageType: {{ request.page_type | json }},
          isCartPage: {% if template contains 'cart' %}true{% else %}false{% endif %},
          isProductPage: {% if template contains 'product' %}true{% else %}false{% endif %},
          isCheckoutPage: {% if template contains 'checkout' %}true{% else %}false{% endif %}
        }
      };

      // Apply custom colors if set
      if (window.CartUpliftSettings.backgroundColor || window.CartUpliftSettings.textColor) {
        const style = document.createElement('style');
        style.textContent = `
          :root {
            --cartuplift-bg-color: ${window.CartUpliftSettings.backgroundColor};
            --cartuplift-text-color: ${window.CartUpliftSettings.textColor};
            --cartuplift-button-color: ${window.CartUpliftSettings.buttonColor};
          }
          
          .cartuplift-sticky-btn {
            background-color: var(--cartuplift-bg-color) !important;
            color: var(--cartuplift-text-color) !important;
          }
          
          .cartuplift-checkout-btn {
            background-color: var(--cartuplift-bg-color) !important;
          }
          
          .cartuplift-shipping-progress-fill {
            background: var(--cartuplift-button-color) !important;
          }
          
          .cartuplift-add-recommendation {
            background-color: var(--cartuplift-bg-color) !important;
          }
          
          .cartuplift-discount-apply {
            background-color: var(--cartuplift-bg-color) !important;
          }
        `;
        document.head.appendChild(style);
      }

      // Debug mode (only in development)
      {% if shop.permanent_domain contains '.myshopify.com' %}
        window.CartUpliftDebug = true;
        console.log('üõí Cart Uplift Debug Mode Enabled');
        console.log('üõí Settings:', window.CartUpliftSettings);
        console.log('üõí Cart Data:', window.CartUpliftPreloadedCart);
      {% endif %}

      // Initialize Cart Uplift when the script is loaded and DOM is ready
      function initCartUplift() {
        if (!window.CartUpliftDrawer) {
          console.error('üõí Cart Uplift script not loaded');
          return;
        }
        
        // Destroy existing instance to prevent double-initialization
        if (window.cartUpliftDrawer?.destroy) {
          window.cartUpliftDrawer.destroy();
        }
        
        // Create a single instance, with settings guaranteed to exist
        window.CartUplift = new CartUpliftDrawer(window.CartUpliftSettings);
        window.cartUpliftDrawer = window.CartUplift;
        console.log('üõí Cart Uplift initialised with settings', window.CartUpliftSettings);
        
        // Dispatch custom event for third-party integrations
        window.dispatchEvent(new CustomEvent('cartuplift:initialized', {
          detail: { cart: window.CartUpliftPreloadedCart }
        }));
      }

      // Wait for DOM and script to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCartUplift);
      } else {
        setTimeout(initCartUplift, 0);
      }
    })();
  </script>
  
  {% comment %} Load JavaScript assets AFTER settings are defined {% endcomment %}
  <script src="{{ 'cart-uplift.js' | asset_url }}" defer="defer"></script>
  
  {% comment %} Main Cart Drawer Container {% endcomment %}
  <div id="cartuplift-app-container" class="cartuplift-container" style="display: none;">
    <div id="cartuplift-backdrop" class="cartuplift-backdrop"></div>
    <div id="cartuplift-cart-popup" class="cartuplift-cart-popup">
      {% comment %} Cart content will be dynamically inserted here by JavaScript {% endcomment %}
    </div>
  </div>
  
  {% comment %} Global Free Shipping Bar (if enabled and not restricted to cart page) {% endcomment %}
  {% unless block.settings.show_only_on_cart_page %}
    {% if block.settings.enable_free_shipping %}
      <div id="cartuplift-shipping-bar" class="cartuplift-shipping-bar" style="display: none;">
        <div class="cartuplift-shipping-content">
          <p class="cartuplift-shipping-text"></p>
          <div class="cartuplift-shipping-progress">
            <div class="cartuplift-shipping-progress-bar"></div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endunless %}
  
  {% comment %} Analytics tracking (optional) {% endcomment %}
  {% if block.settings.enable_analytics %}
    <script>
      document.addEventListener('cartuplift:opened', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'view_cart', {
            'event_category': 'Cart Uplift',
            'event_label': 'Cart Drawer Opened'
          });
        }
      });
      
      document.addEventListener('cartuplift:item_added', function(e) {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'add_to_cart', {
            'event_category': 'Cart Uplift',
            'event_label': 'Item Added',
            'value': e.detail.price
          });
        }
      });
    </script>
  {% endif %}
  
{% endif %}

{% schema %}
{
  "name": "Cart Uplift",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "‚öôÔ∏è General Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_app",
      "label": "Enable Cart Uplift",
      "default": true,
      "info": "Turn on/off the entire cart drawer functionality"
    },
    {
      "type": "header",
      "content": "üõí Sticky Cart Button"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_cart",
      "label": "Enable Sticky Cart Button",
      "default": true,
      "info": "Shows a floating cart button on your store"
    },
    {
      "type": "checkbox",
      "id": "show_only_on_cart_page",
      "label": "Show only on cart page",
      "default": false,
      "info": "Restrict the cart drawer to only appear on /cart page"
    },
    {
      "type": "select",
      "id": "cart_position",
      "label": "Cart Button Position",
      "options": [
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "middle-right",
          "label": "Middle Right"
        },
        {
          "value": "middle-left",
          "label": "Middle Left"
        }
      ],
      "default": "bottom-right"
    },
    {
      "type": "select",
      "id": "cart_icon",
      "label": "Cart Icon Style",
      "options": [
        {
          "value": "bag",
          "label": "Shopping Bag"
        },
        {
          "value": "cart",
          "label": "Shopping Cart"
        },
        {
          "value": "basket",
          "label": "Basket"
        }
      ],
      "default": "cart"
    },
    {
      "type": "header",
      "content": "üöö Free Shipping Bar"
    },
    {
      "type": "checkbox",
      "id": "enable_free_shipping",
      "label": "Enable Free Shipping Progress",
      "default": true,
      "info": "Shows progress toward free shipping threshold"
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold",
      "default": 100,
      "info": "Amount in your store's currency"
    },
    {
      "type": "text",
      "id": "shipping_message",
      "label": "Progress Message",
      "default": "You are {amount} away from free shipping!",
      "info": "Use {amount} as placeholder for remaining amount"
    },
    {
      "type": "text",
      "id": "shipping_success_message",
      "label": "Success Message",
      "default": "üéâ Congratulations! You have unlocked free shipping!"
    },
    {
      "type": "header",
      "content": "üé® Appearance"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button/Progress Color",
      "default": "#4CAF50"
    },
    {
      "type": "header",
      "content": "üõçÔ∏è Recommendations & Upsells"
    },
    {
      "type": "checkbox",
      "id": "enable_recommendations",
      "label": "Enable Product Recommendations",
      "default": true,
      "info": "Show recommended products in cart"
    },
    {
      "type": "select",
      "id": "recommendation_layout",
      "label": "Recommendation Layout",
      "options": [
        {
          "value": "row",
          "label": "Horizontal Cards (like image 1)"
        },
        {
          "value": "column",
          "label": "Vertical List (like image 2)"
        }
      ],
      "default": "row",
      "info": "Choose how recommendations are displayed"
    },
    {
      "type": "checkbox",
      "id": "enable_upsells",
      "label": "Enable Upsells",
      "default": true,
      "info": "Show upsell suggestions"
    },
    {
      "type": "checkbox",
      "id": "enable_quantity_breaks",
      "label": "Enable Quantity Discounts",
      "default": false,
      "info": "Show bulk discount tiers"
    },
    {
      "type": "range",
      "id": "max_upsells",
      "label": "Maximum Recommendations to Show",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "‚ûï Additional Features"
    },
    {
      "type": "checkbox",
      "id": "enable_addons",
      "label": "Enable Add-ons",
      "default": false,
      "info": "Show gift wrapping, insurance, etc."
    },
    {
      "type": "checkbox",
      "id": "enable_express_checkout",
      "label": "Enable Express Checkout",
      "default": true,
      "info": "Show PayPal, Shop Pay buttons"
    },
    {
      "type": "header",
      "content": "üîß Additional Options"
    },
    {
      "type": "checkbox",
      "id": "enable_notes",
      "label": "Enable Order Notes",
      "default": false,
      "info": "Allow customers to add notes to their order"
    },
    {
      "type": "checkbox",
      "id": "enable_discount_code",
      "label": "Show Discount Code Field",
      "default": false,
      "info": "Display discount code input in cart"
    },
    {
      "type": "checkbox",
      "id": "auto_open_cart",
      "label": "Auto-open Cart on Add",
      "default": true,
      "info": "Automatically open cart when item is added"
    },
    {
      "type": "checkbox",
      "id": "enable_analytics",
      "label": "Enable Analytics Tracking",
      "default": false,
      "info": "Track cart events in Google Analytics"
    }
  ]
}
{% endschema %}