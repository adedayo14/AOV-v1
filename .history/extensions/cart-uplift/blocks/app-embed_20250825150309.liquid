{% comment %} 
  Cart Uplift - Theme App Extension.
  This app embed enables a custom cart drawer with upsells and free shipping progress
{% endcomment %}

{% if block.settings.enable_app %}
  {% comment %} Load CSS first {% endcomment %}
  <link rel="stylesheet" href="{{ 'cart-uplift.css' | asset_url }}">
  
  {% comment %} Initialize UpCart with settings and data BEFORE loading the main script {% endcomment %}
  <script>
    (function() {
      // Preload cart data for faster initial load
      window.CartUpliftPreloadedCart = {{ cart | json }};
      
      // Store money format for proper price display
      window.CartUpliftMoneyFormat = {{ shop.money_format | json }};
      
      // Store shop information
      window.CartUpliftShopInfo = {
        domain: {{ shop.permanent_domain | json }},
        currency: {{ shop.currency | json }},
        moneyFormat: {{ shop.money_format | json }},
        moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }}
      };
      
      // Main Cart Uplift settings from theme editor
      window.CartUpliftSettings = {
        // General settings
        enableApp: {{ block.settings.enable_app | default: true | json }},
        shopDomain: {{ shop.permanent_domain | json }},
        
        // Sticky cart settings
        enableStickyCart: {{ block.settings.enable_sticky_cart | default: true | json }},
        showOnlyOnCartPage: false, // Default fallback since not in schema
        cartPosition: 'bottom-right', // Default fallback since not in schema
        cartIcon: 'cart', // Default fallback since not in schema
        
        // Free shipping settings
        enableFreeShipping: {{ block.settings.enable_free_shipping | default: true | json }},
        freeShippingThreshold: {{ block.settings.free_shipping_threshold | default: 100 | json }},
        shippingMessage: 'You are {amount} away from free shipping!', // Default fallback
        shippingSuccessMessage: 'üéâ Congratulations! You have unlocked free shipping!', // Default fallback
        
        // Styling settings
        backgroundColor: '#1a1a1a', // Default fallback since not in schema
        textColor: '#FFFFFF', // Default fallback since not in schema
        buttonColor: {{ block.settings.button_color | default: '#4CAF50' | json }},
        
        // Upsell and recommendation settings
        enableUpsells: true, // Default fallback since not in schema
        enableRecommendations: {{ block.settings.enable_recommendations | default: true | json }},
        recommendationLayout: 'row', // Default fallback since not in schema
        enableQuantityBreaks: false, // Default fallback since not in schema
        maxUpsells: 4, // Default fallback since not in schema
        
        // Add-on settings
        enableAddons: false, // Default fallback since not in schema
        enableExpressCheckout: true, // Default fallback since not in schema
        
        // Additional settings
        enableNotes: false, // Default fallback since not in schema
        enableDiscountCode: false, // Default fallback since not in schema
        autoOpenCart: true, // Default fallback since not in schema
        
        // Localization
        locale: {{ request.locale.iso_code | json }},
        
        // Page context
        currentPage: {
          template: {{ template | json }},
          pageType: {{ request.page_type | json }},
          isCartPage: {% if template contains 'cart' %}true{% else %}false{% endif %},
          isProductPage: {% if template contains 'product' %}true{% else %}false{% endif %},
          isCheckoutPage: {% if template contains 'checkout' %}true{% else %}false{% endif %}
        }
      };

      // Apply custom colors if set
      if (window.CartUpliftSettings.buttonColor) {
        const style = document.createElement('style');
        style.textContent = `
          :root {
            --cartuplift-button-color: ${window.CartUpliftSettings.buttonColor};
          }
          
          .cartuplift-header-progress-fill {
            background: var(--cartuplift-button-color) !important;
          }
          
          .cartuplift-header-shipping-progress-fill {
            background: var(--cartuplift-button-color) !important;
          }
          
          .cartuplift-shipping-progress-fill {
            background: var(--cartuplift-button-color) !important;
          }
          
          .cartuplift-checkout-btn {
            background-color: var(--cartuplift-button-color) !important;
          }
          
          .cartuplift-sticky-btn {
            background-color: var(--cartuplift-button-color) !important;
          }
        `;
        document.head.appendChild(style);
      }
          
          .cartuplift-add-recommendation {
            background-color: var(--cartuplift-bg-color) !important;
          }
          
          .cartuplift-discount-apply {
            background-color: var(--cartuplift-bg-color) !important;
          }
        `;
        document.head.appendChild(style);
      }

      // Debug mode (only in development)
      {% if shop.permanent_domain contains '.myshopify.com' %}
        window.CartUpliftDebug = true;
        console.log('üõí Cart Uplift Debug Mode Enabled');
        console.log('üõí Settings:', window.CartUpliftSettings);
        console.log('üõí Cart Data:', window.CartUpliftPreloadedCart);
      {% endif %}

      // Initialize Cart Uplift when the script is loaded and DOM is ready
      function initCartUplift() {
        if (!window.CartUpliftDrawer) {
          console.error('üõí Cart Uplift script not loaded');
          return;
        }
        
        // Destroy existing instance to prevent double-initialization
        if (window.cartUpliftDrawer?.destroy) {
          window.cartUpliftDrawer.destroy();
        }
        
        // Create a single instance, with settings guaranteed to exist
        window.CartUplift = new CartUpliftDrawer(window.CartUpliftSettings);
        window.cartUpliftDrawer = window.CartUplift;
        console.log('üõí Cart Uplift initialised with settings', window.CartUpliftSettings);
        
        // Dispatch custom event for third-party integrations
        window.dispatchEvent(new CustomEvent('cartuplift:initialized', {
          detail: { cart: window.CartUpliftPreloadedCart }
        }));
      }

      // Wait for DOM and script to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCartUplift);
      } else {
        setTimeout(initCartUplift, 0);
      }
    })();
  </script>
  
  {% comment %} Load JavaScript assets AFTER settings are defined {% endcomment %}
  <script src="{{ 'cart-uplift.js' | asset_url }}" defer="defer"></script>
  
  {% comment %} Main Cart Drawer Container {% endcomment %}
  <div id="cartuplift-app-container" class="cartuplift-container" style="display: none;">
    <div id="cartuplift-backdrop" class="cartuplift-backdrop"></div>
    <div id="cartuplift-cart-popup" class="cartuplift-cart-popup">
      {% comment %} Cart content will be dynamically inserted here by JavaScript {% endcomment %}
    </div>
  </div>
  
  {% comment %} Global Free Shipping Bar (if enabled and not restricted to cart page) {% endcomment %}
  {% unless block.settings.show_only_on_cart_page %}
    {% if block.settings.enable_free_shipping %}
      <div id="cartuplift-shipping-bar" class="cartuplift-shipping-bar" style="display: none;">
        <div class="cartuplift-shipping-content">
          <p class="cartuplift-shipping-text"></p>
          <div class="cartuplift-shipping-progress">
            <div class="cartuplift-shipping-progress-bar"></div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endunless %}
  
  {% comment %} Analytics tracking (optional) {% endcomment %}
  {% if block.settings.enable_analytics %}
    <script>
      document.addEventListener('cartuplift:opened', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'view_cart', {
            'event_category': 'Cart Uplift',
            'event_label': 'Cart Drawer Opened'
          });
        }
      });
      
      document.addEventListener('cartuplift:item_added', function(e) {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'add_to_cart', {
            'event_category': 'Cart Uplift',
            'event_label': 'Item Added',
            'value': e.detail.price
          });
        }
      });
    </script>
  {% endif %}
  
{% endif %}

{% schema %}
{
  "name": "Cart Uplift",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "‚öôÔ∏è Cart Configuration"
    },
    {
      "type": "checkbox",
      "id": "enable_app",
      "label": "Enable Cart Uplift",
      "default": true,
      "info": "Turn on/off the entire cart drawer functionality"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_cart",
      "label": "Enable Sticky Cart Button",
      "default": true,
      "info": "Shows a floating cart button on your store"
    },
    {
      "type": "checkbox",
      "id": "enable_free_shipping",
      "label": "Enable Free Shipping Progress",
      "default": true,
      "info": "Shows progress toward free shipping threshold"
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold",
      "default": 100,
      "info": "Amount in your store's currency"
    },
    {
      "type": "checkbox",
      "id": "enable_recommendations",
      "label": "Enable Product Recommendations",
      "default": true,
      "info": "Show recommended products in cart"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button/Progress Color",
      "default": "#4CAF50"
    }
  ]
}
{% endschema %}
