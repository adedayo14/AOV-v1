{% comment %} 
  UpCart Cart Drawer - Theme App Extension
  This app embed enables a custom cart drawer with upsells and free shipping progress
{% endcomment %}

{% if block.settings.enable_app %}
  {% comment %} Load CSS and JavaScript assets {% endcomment %}
  <link rel="stylesheet" href="{{ 'cart-drawer.css' | asset_url }}">
  <script src="{{ 'cart-drawer.js' | asset_url }}" defer="defer"></script>
  
  {% comment %} Main Cart Drawer Container {% endcomment %}
  <div id="upcart-app-container" class="upcart-container" style="display: none;">
    <div id="upcart-backdrop" class="upcart-backdrop"></div>
    <div id="upcart-cart-popup" class="upcart-cart-popup">
      {% comment %} Cart content will be dynamically inserted here by JavaScript {% endcomment %}
    </div>
  </div>
  
  {% comment %} Global Free Shipping Bar (if enabled and not restricted to cart page) {% endcomment %}
  {% unless block.settings.show_only_on_cart_page %}
    {% if block.settings.enable_free_shipping %}
      <div id="upcart-shipping-bar" class="upcart-shipping-bar" style="display: none;">
        <div class="upcart-shipping-content">
          <p class="upcart-shipping-text"></p>
          <div class="upcart-shipping-progress">
            <div class="upcart-shipping-progress-bar"></div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endunless %}
  
  {% comment %} Initialize UpCart with settings and data {% endcomment %}
  <script>
    (function() {
      // Preload cart data for faster initial load
      window.UpCartPreloadedCart = {{ cart | json }};
      
      // Store money format for proper price display
      window.UpCartMoneyFormat = {{ shop.money_format | json }};
      
      // Store shop information
      window.UpCartShopInfo = {
        domain: {{ shop.permanent_domain | json }},
        currency: {{ shop.currency | json }},
        moneyFormat: {{ shop.money_format | json }},
        moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }}
      };
      
      // Main UpCart settings from theme editor
      window.UpCartSettings = {
        // General settings
        enableApp: true,
        shopDomain: {{ shop.permanent_domain | json }},
        
        // Sticky cart settings
        enableStickyCart: {{ block.settings.enable_sticky_cart | default: true | json }},
        showOnlyOnCartPage: {{ block.settings.show_only_on_cart_page | default: false | json }},
        cartPosition: {{ block.settings.cart_position | default: 'bottom-right' | json }},
        cartIcon: {{ block.settings.cart_icon | default: 'cart' | json }},
        
        // Free shipping settings
        enableFreeShipping: {{ block.settings.enable_free_shipping | default: true | json }},
        freeShippingThreshold: {{ block.settings.free_shipping_threshold | default: 100 | json }},
        shippingMessage: {{ block.settings.shipping_message | default: 'You are {amount} away from free shipping!' | json }},
        shippingSuccessMessage: {{ block.settings.shipping_success_message | default: 'üéâ Congratulations! You have unlocked free shipping!' | json }},
        
        // Styling settings
        backgroundColor: {{ block.settings.background_color | default: '#000000' | json }},
        textColor: {{ block.settings.text_color | default: '#FFFFFF' | json }},
        buttonColor: {{ block.settings.button_color | default: '#4CAF50' | json }},
        
        // Upsell settings
        enableUpsells: {{ block.settings.enable_upsells | default: true | json }},
        enableQuantityBreaks: {{ block.settings.enable_quantity_breaks | default: false | json }},
        maxUpsells: {{ block.settings.max_upsells | default: 4 | json }},
        
        // Additional settings
        enableNotes: {{ block.settings.enable_notes | default: false | json }},
        enableDiscountCode: {{ block.settings.enable_discount_code | default: false | json }},
        autoOpenCart: {{ block.settings.auto_open_cart | default: true | json }},
        
        // Localization
        locale: {{ request.locale.iso_code | json }},
        
        // Page context
        currentPage: {
          template: {{ template | json }},
          pageType: {{ request.page_type | json }},
          isCartPage: {% if template contains 'cart' %}true{% else %}false{% endif %},
          isProductPage: {% if template contains 'product' %}true{% else %}false{% endif %},
          isCheckoutPage: {% if template contains 'checkout' %}true{% else %}false{% endif %}
        }
      };
      
      // Apply custom colors if set
      if (window.UpCartSettings.backgroundColor || window.UpCartSettings.textColor) {
        const style = document.createElement('style');
        style.textContent = `
          :root {
            --upcart-bg-color: ${window.UpCartSettings.backgroundColor};
            --upcart-text-color: ${window.UpCartSettings.textColor};
            --upcart-button-color: ${window.UpCartSettings.buttonColor};
          }
          
          .upcart-trigger {
            background-color: var(--upcart-bg-color) !important;
            color: var(--upcart-text-color) !important;
          }
          
          .upcart-checkout {
            background-color: var(--upcart-button-color) !important;
          }
          
          .upcart-progress-fill {
            background: var(--upcart-button-color) !important;
          }
        `;
        document.head.appendChild(style);
      }
      
      // Debug mode (only in development)
      {% if shop.permanent_domain contains '.myshopify.com' %}
        window.UpCartDebug = true;
        console.log('üõí UpCart Debug Mode Enabled');
        console.log('üõí Settings:', window.UpCartSettings);
        console.log('üõí Cart Data:', window.UpCartPreloadedCart);
      {% endif %}
      
      // Initialize UpCart when DOM is ready
      function initUpCart() {
        if (typeof UpCartDrawer !== 'undefined') {
          window.UpCart = new UpCartDrawer(window.UpCartSettings);
          console.log('üõí UpCart initialized successfully');
          
          // Dispatch custom event for third-party integrations
          window.dispatchEvent(new CustomEvent('upcart:initialized', {
            detail: { cart: window.UpCartPreloadedCart }
          }));
        } else {
          console.error('üõí UpCart script not loaded');
        }
      }
      
      // Wait for DOM and script to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initUpCart);
      } else {
        // DOM already loaded, wait a bit for script
        setTimeout(initUpCart, 100);
      }
    })();
  </script>
  
  {% comment %} Analytics tracking (optional) {% endcomment %}
  {% if block.settings.enable_analytics %}
    <script>
      document.addEventListener('upcart:opened', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'view_cart', {
            'event_category': 'UpCart',
            'event_label': 'Cart Drawer Opened'
          });
        }
      });
      
      document.addEventListener('upcart:item_added', function(e) {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'add_to_cart', {
            'event_category': 'UpCart',
            'event_label': 'Item Added',
            'value': e.detail.price
          });
        }
      });
    </script>
  {% endif %}
  
{% endif %}

{% schema %}
{
  "name": "UpCart Cart Drawer",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "‚öôÔ∏è General Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_app",
      "label": "Enable UpCart",
      "default": true,
      "info": "Turn on/off the entire cart drawer functionality"
    },
    {
      "type": "header",
      "content": "üõí Sticky Cart Button"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_cart",
      "label": "Enable Sticky Cart Button",
      "default": true,
      "info": "Shows a floating cart button on your store"
    },
    {
      "type": "checkbox",
      "id": "show_only_on_cart_page",
      "label": "Show only on cart page",
      "default": false,
      "info": "Restrict the cart drawer to only appear on /cart page"
    },
    {
      "type": "select",
      "id": "cart_position",
      "label": "Cart Button Position",
      "options": [
        {
          "value": "bottom-right",
          "label": "Bottom Right"
        },
        {
          "value": "bottom-left",
          "label": "Bottom Left"
        },
        {
          "value": "middle-right",
          "label": "Middle Right"
        },
        {
          "value": "middle-left",
          "label": "Middle Left"
        }
      ],
      "default": "bottom-right"
    },
    {
      "type": "select",
      "id": "cart_icon",
      "label": "Cart Icon Style",
      "options": [
        {
          "value": "bag",
          "label": "Shopping Bag"
        },
        {
          "value": "cart",
          "label": "Shopping Cart"
        },
        {
          "value": "basket",
          "label": "Basket"
        }
      ],
      "default": "cart"
    },
    {
      "type": "header",
      "content": "üöö Free Shipping Bar"
    },
    {
      "type": "checkbox",
      "id": "enable_free_shipping",
      "label": "Enable Free Shipping Progress",
      "default": true,
      "info": "Shows progress toward free shipping threshold"
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free Shipping Threshold",
      "default": 100,
      "info": "Amount in your store's currency"
    },
    {
      "type": "text",
      "id": "shipping_message",
      "label": "Progress Message",
      "default": "You are {amount} away from free shipping!",
      "info": "Use {amount} as placeholder for remaining amount"
    },
    {
      "type": "text",
      "id": "shipping_success_message",
      "label": "Success Message",
      "default": "üéâ Congratulations! You have unlocked free shipping!"
    },
    {
      "type": "header",
      "content": "üé® Appearance"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#4CAF50"
    },
    {
      "type": "header",
      "content": "üí∞ Upsells & Features"
    },
    {
      "type": "checkbox",
      "id": "enable_upsells",
      "label": "Enable Product Recommendations",
      "default": true,
      "info": "Show recommended products in cart"
    },
    {
      "type": "checkbox",
      "id": "enable_quantity_breaks",
      "label": "Enable Quantity Discounts",
      "default": false,
      "info": "Show bulk discount tiers"
    },
    {
      "type": "range",
      "id": "max_upsells",
      "label": "Maximum Upsells to Show",
      "min": 1,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "üîß Additional Options"
    },
    {
      "type": "checkbox",
      "id": "enable_notes",
      "label": "Enable Order Notes",
      "default": false,
      "info": "Allow customers to add notes to their order"
    },
    {
      "type": "checkbox",
      "id": "enable_discount_code",
      "label": "Show Discount Code Field",
      "default": false,
      "info": "Display discount code input in cart"
    },
    {
      "type": "checkbox",
      "id": "auto_open_cart",
      "label": "Auto-open Cart on Add",
      "default": true,
      "info": "Automatically open cart when item is added"
    },
    {
      "type": "checkbox",
      "id": "enable_analytics",
      "label": "Enable Analytics Tracking",
      "default": false,
      "info": "Track cart events in Google Analytics"
    }
  ]
}
{% endschema %}