{% comment %} Cart Uplift â€“ Upsells Settings {% endcomment %}

{% comment %} Cart Uplift â€“ Upsells Settings {% endcomment %}

<script>
  (function() {
    // Wait for document to be ready
    function updateSettings() {
      // Ensure global settings exist
      window.CartUpliftSettings = window.CartUpliftSettings || {};
      
      // Merge in the recommendation settings
      Object.assign(window.CartUpliftSettings, {
        enableRecommendations: {{ block.settings.enable_recommendations | default: true | json }},
        recommendationLayout: {{ block.settings.recommendation_layout | default: 'column' | json }},
        maxRecommendations: {{ block.settings.max_recommendations | default: 4 | json }},
        recommendationsTitle: {{ block.settings.recommendations_title | default: 'You might also like' | json }}
      });
      
      console.log('ðŸ›’ Upsell settings applied:', {
        enableRecommendations: window.CartUpliftSettings.enableRecommendations,
        recommendationLayout: window.CartUpliftSettings.recommendationLayout,
        maxRecommendations: window.CartUpliftSettings.maxRecommendations,
        recommendationsTitle: window.CartUpliftSettings.recommendationsTitle
      });
      
      // Dispatch event to notify drawer
      try {
        document.dispatchEvent(new CustomEvent('cartuplift:settings:updated', {
          detail: { source: 'upsell-embed' }
        }));
        console.log('ðŸ›’ Dispatched settings update event');
      } catch (e) {
        console.warn('ðŸ›’ Failed to dispatch settings update:', e);
      }
      
      // If drawer already exists, force update
      if (window.cartUpliftDrawer && window.cartUpliftDrawer.updateDrawerContent) {
        console.log('ðŸ›’ Directly updating drawer with new settings');
        window.cartUpliftDrawer.settings = Object.assign(
          window.cartUpliftDrawer.settings || {}, 
          window.CartUpliftSettings
        );
        
        // Load recommendations if not loaded
        if (window.CartUpliftSettings.enableRecommendations && 
            !window.cartUpliftDrawer._recommendationsLoaded) {
          window.cartUpliftDrawer.loadRecommendations().then(() => {
            window.cartUpliftDrawer.updateDrawerContent();
          });
        } else {
          window.cartUpliftDrawer.updateDrawerContent();
        }
      }
    }
    
    // Run immediately
    updateSettings();
    
    // Also run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateSettings);
    } else {
      // DOM is already ready, run with a small delay
      setTimeout(updateSettings, 100);
    }
    
    // Final fallback after everything should be loaded
    setTimeout(updateSettings, 1000);
  })();
</script>

{% schema %}
{
  "name": "Upsells",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "ðŸ“¦ Product Recommendations"
    },
    {
      "type": "checkbox",
      "id": "enable_recommendations",
      "label": "Enable Product Recommendations",
      "default": true,
      "info": "Show recommended products in cart"
    },
    {
      "type": "select",
      "id": "recommendation_layout",
      "label": "Recommendation Layout",
      "default": "column",
      "options": [
        {
          "value": "row",
          "label": "Horizontal Row (Card Style)"
        },
        {
          "value": "column",
          "label": "Vertical List (Compact Style)"
        }
      ]
    },
    {
      "type": "range",
      "id": "max_recommendations",
      "label": "Max Recommendations",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Recommendations Title",
      "default": "You might also like",
      "info": "Title shown above recommendations"
    }
  ]
}
{% endschema %}
